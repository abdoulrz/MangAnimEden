{% extends 'base.html' %}

{% block title %}{{ series.title }} - MangAnimEDen{% endblock %}

{% block content %}
<div class="container detail-page-container">
    <!-- Breadcrumb / Back Navigation -->
    <div class="detail-nav-top">
        <a href="{% url 'home' %}" class="btn-back">
            <svg class="icon icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Retour Ã  l'accueil
        </a>
    </div>

    <!-- Header Section -->
    <div class="detail-header">
        <!-- Background Blur/Glow Effect (Optional) -->
        <div class="detail-bg-glow"></div>

        <!-- Left: Cover Image -->
        <div class="detail-cover-wrapper">
            <div class="detail-cover neumorphic-card">
                {% if series.cover %}
                <img src="{{ series.cover.url }}" alt="{{ series.title }}" class="detail-image">
                {% else %}
                <div class="detail-image mock-cover-detail"></div>
                {% endif %}
            </div>
        </div>

        <!-- Right: Info & Actions -->
        <div class="detail-info">
            <div class="detail-meta-top">
                <span class="badge-status-pill">{{ series.get_status_display|default:"En cours" }}</span>
            </div>

            <h1 class="detail-title">{{ series.title }}</h1>

            <div class="detail-stats">
                <span class="stat-item">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    {{ series.author|default:"Auteur inconnu" }}
                </span>
                <span class="stat-item">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    {{ chapters.count }} chapitres
                </span>
                <span class="stat-item">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    {{ series.release_date|default:series.created_at|date:"M Y"|capfirst }}
                </span>
            </div>

            <div class="detail-actions">
                {% if last_read_chapter %}
                <a href="{% url 'reader:demo_chapter' last_read_chapter.id %}" class="btn btn-primary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Lire (Ch. {{ last_read_chapter.number }})
                </a>
                {% elif chapters.first %}
                <a href="{% url 'reader:demo_chapter' chapters.first.id %}" class="btn btn-primary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Commencer
                </a>
                {% endif %}
                <button class="btn btn-secondary btn-chat">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg> Chat communautaire
                </button>
                <button class="btn btn-icon btn-favorite {% if is_favorite %}liked{% endif %}"
                    onclick="toggleFavorite(this)" aria-label="Ajouter aux favoris" data-series-id="{{ series.id }}">
                    <!-- Outline Heart (Visible by default) -->
                    <svg class="heart-icon heart-outline" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                    <!-- Solid Heart (Hidden by default) -->
                    <svg class="heart-icon heart-solid" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                        fill="currentColor" stroke="none">
                        <path
                            d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="detail-tabs-container">
        <div class="detail-tabs">
            <button class="tab-link active" onclick="openTab(event, 'chapters')">
                <span class="tab-icon"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    </svg></span> Chapitres
            </button>
            <button class="tab-link" onclick="openTab(event, 'info')">
                <span class="tab-icon"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg></span> Info
            </button>
            <button class="tab-link" onclick="openTab(event, 'reviews')">
                <span class="tab-icon"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                        </path>
                    </svg></span> Avis
            </button>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="detail-content-wrapper">
        <!-- Chapters Tab -->
        <div id="chapters" class="tab-content active">
            {% if chapters %}
            <div class="chapters-grid">
                {% for chapter in chapters %}
                <a href="{% url 'reader:demo_chapter' chapter.id %}" class="chapter-item">
                    <div class="chapter-info">
                        <span class="chapter-number">Chapter {{ chapter.number|stringformat:".1f" }}</span>
                        {% if chapter.title and "Chapter" not in chapter.title and "Chapitre" not in chapter.title %}
                        <span class="chapter-name">{{ chapter.title }}</span>
                        {% endif %}
                    </div>
                    <span class="chapter-date">{{ chapter.created_at|date:"d M Y" }}</span>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="chapters-list empty-state-dark">
                <div class="empty-icon-large">
                    <svg class="icon icon-xxl" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    </svg>
                </div>
                <p class="empty-text">Aucun chapitre disponible</p>
            </div>
            {% endif %}
        </div>

        <!-- Informations Tab -->
        <div id="info" class="tab-content">
            <div class="info-content-box">
                {% if series.description %}
                <p class="description-text">{{ series.description|linebreaks }}</p>
                {% else %}
                <div class="empty-icon-large">
                    <svg class="icon icon-xxl" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                </div>
                <p class="empty-text">
                    Aucune information pour le moment
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Avis Tab -->
        <div id="reviews" class="tab-content">
            <div class="empty-state-dark">
                <div class="empty-icon-large">
                    <svg class="icon icon-xxl" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                        </path>
                    </svg>
                </div>
                <p class="empty-text">Aucun avis pour le moment</p>
            </div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function toggleFavorite(btn) {
        const seriesId = btn.dataset.seriesId;
        const csrftoken = getCookie('csrftoken');

        fetch(`/catalogue/series/${seriesId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            mode: 'same-origin'
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 403 || response.status === 401) {
                    window.location.href = "{% url 'login' %}?next={{ request.path }}";
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                if (data.is_favorite) {
                    btn.classList.add("liked");
                } else {
                    btn.classList.remove("liked");
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>
</div>
{% endblock %}