{% extends 'base.html' %}
{% load static %}

{% block title %}Lecteur - {{ page.chapter.series.title|default:"MangAnimEDen" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reader.css' %}?v={{ STATIC_VERSION }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
{% endblock %}

{% block content %}
<div class="reader-container" id="reader-container">
    {% if chapter %}
    <div class="reader-info">
        <h1 class="reader-title">{{ chapter.series.title }}</h1>
        <p class="reader-subtitle">
            Chapter {{ chapter.number|stringformat:".1f" }}
            {% if chapter.title and "Chapter" not in chapter.title and "Chapitre" not in chapter.title %}
            - {{ chapter.title }}
            {% endif %}
        </p>
        <div class="reader-back-container">
            <a href="{% url 'catalog:detail' chapter.series.id %}" class="nav-btn btn-sm">
                ‚Üê Retour √† la fiche
            </a>
        </div>
    </div>

    <!-- Navigation Top -->
    <div class="chapter-nav">
        {% if prev_chapter %}
        <a href="{% url 'reader:demo_chapter' prev_chapter.id %}" class="nav-btn">‚Üê Pr√©c√©dent</a>
        {% else %}
        <span class="nav-btn disabled">‚Üê Pr√©c√©dent</span>
        {% endif %}

        {% if next_chapter %}
        <a href="{% url 'reader:demo_chapter' next_chapter.id %}" class="nav-btn">Suivant ‚Üí</a>
        {% else %}
        <span class="nav-btn disabled">Suivant ‚Üí</span>
        {% endif %}
    </div>

    {% if chapter.is_pdf %}
    <!-- PDF MODE -->
    <div id="pdf-render-container" data-url="{{ chapter.source_file.url }}">
        <!-- Canvas elements will be injected here -->
    </div>
    {% elif pages %}
    <!-- IMAGE MODE -->
    {% for p in pages %}
    <img class="manga-page lazy reader-page" data-src="{{ p.image.url }}" alt="Page {{ p.page_number }}">
    {% endfor %}
    {% else %}
    <div class="reader-empty">
        <h2 class="reader-empty-title">Chapitre vide</h2>
    </div>
    {% endif %}

    <!-- Navigation Bottom -->
    <div class="chapter-nav">
        {% if prev_chapter %}
        <a href="{% url 'reader:demo_chapter' prev_chapter.id %}" class="nav-btn">‚Üê Pr√©c√©dent</a>
        {% else %}
        <span class="nav-btn disabled">‚Üê Pr√©c√©dent</span>
        {% endif %}

        {% if next_chapter %}
        <a href="{% url 'reader:demo_chapter' next_chapter.id %}" class="nav-btn">Suivant ‚Üí</a>
        {% else %}
        <span class="nav-btn disabled">Suivant ‚Üí</span>
        {% endif %}
    </div>

    {% else %}
    <div class="reader-empty">
        <div class="reader-empty-icon">üìö</div>
        <h2 class="reader-empty-title">Aucun chapitre trouv√©</h2>
    </div>
    {% endif %}

</div>

<!-- Scroll To Top Button -->



<!-- Reader Controls & Settings -->
<div class="reader-controls-layer">
    <!-- Gear Icon -->
    <button id="settingsBtn" class="settings-btn" title="Param√®tres de lecture">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
            </path>
        </svg>
    </button>

    <!-- Settings Modal/Menu -->
    <div id="settingsMenu" class="settings-menu hidden">
        <h3>Param√®tres de lecture</h3>

        <div class="setting-group">
            <label>Mode de lecture</label>
            <div class="mode-toggles">
                <button class="mode-btn active" data-mode="vertical">Vertical</button>
                <button class="mode-btn" data-mode="webtoon">Webtoon</button>
                <button class="mode-btn" data-mode="paged">Par Page</button>
            </div>
        </div>

        <div class="setting-group paged-only hidden">
            <label>Direction</label>
            <div class="mode-toggles">
                <button class="dir-btn active" data-dir="ltr">De G. √† D.</button>
                <button class="dir-btn" data-dir="rtl">De D. √† G. (Manga)</button>
            </div>
        </div>

        <div class="setting-group vertical-only">
            <label class="checkbox-label">
                <input type="checkbox" id="gaplessToggle">
                Lecture sans espace (Gapless)
            </label>
        </div>

        <div class="setting-group action-group">
            <label>Actions</label>
            <div class="mode-toggles">
                <button class="action-btn"
                    onclick="window.scrollTo({top: 0, behavior: 'smooth'}); document.getElementById('settingsMenu').classList.add('hidden');">
                    <i class="fas fa-arrow-up"></i> Haut
                </button>
                <a href="{% url 'catalog:detail' chapter.series.id %}" class="action-btn">
                    <i class="fas fa-info-circle"></i> Fiche
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Click Zones for Paged Mode -->
<div id="clickZoneLeft" class="click-zone left hidden" title="Pr√©c√©dent">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
</div>
<div id="clickZoneRight" class="click-zone right hidden" title="Suivant">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
</div>

<div id="reader-data" class="hidden" data-total="{{ chapter.pages.count|default:'1' }}" data-mode="vertical"></div>
{% endblock %}

{% block extra_js %}
<script>

</script>
{% if chapter and not chapter.pdf_file %}
<script src="{% static 'js/reader.js' %}?v={{ STATIC_VERSION }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const readerData = document.getElementById('reader-data');
        const totalPages = readerData ? readerData.dataset.total : 1;
        MangaReader.init(totalPages);
    });
</script>
{% endif %}

{% if chapter and chapter.pdf_file %}
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // Force scroll to top prevents "slightly scrolled" issue on refresh
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        window.scrollTo(0, 0);

        const container = document.getElementById('pdf-render-container');
        const url = container.dataset.url;

        if (!url) return;

        try {
            const loadingTask = pdfjsLib.getDocument(url);
            const pdf = await loadingTask.promise;
            console.log('PDF loaded');

            // Render all pages
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);

                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });

                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page';
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Adjust styling max-width
                canvas.style.maxWidth = '100%';
                canvas.style.height = 'auto';

                container.appendChild(canvas);

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                page.render(renderContext);
            }
        } catch (error) {
            console.error('Error loading PDF:', error);
            container.innerHTML = '<p class="error">Erreur lors du chargement du PDF.</p>';
        }
    });
</script>
{% endif %}
{% endblock %}