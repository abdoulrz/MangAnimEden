{% extends "administration/base_admin.html" %}

{% block admin_content %}
<div class="admin-header">
    <h1 class="admin-page-title">Gestion des Utilisateurs</h1>
    <div class="admin-controls">
        <form method="get" class="admin-search-form">
            <input type="text" name="q" placeholder="Rechercher (pseudo, email)..." value="{{ request.GET.q }}">
            <button type="submit" class="btn btn-primary">Rechercher</button>
        </form>
    </div>
</div>

<table class="admin-table">
    <thead>
        <tr>
            <th>Utilisateur</th>
            <th>Email</th>
            <th>RÃ´les</th>
            <th>Statut</th>
            <th>Inscrit le</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>
                <div class="user-cell">
                    {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="avatar" class="avatar-small">
                    {% else %}
                    <div class="avatar-placeholder-small">{{ user.nickname|first|upper }}</div>
                    {% endif %}
                    <span class="username">{{ user.nickname }}</span>
                </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
                {% if user.is_superuser %}<span class="role-badge superadmin">SuperUser</span>{% endif %}
                {% if user.role_admin %}<span class="role-badge admin">Admin</span>{% endif %}
                {% if user.role_moderator %}<span class="role-badge mod">Mod</span>{% endif %}
                {% if not user.role_admin and not user.role_moderator and not user.is_superuser %}Lecteur{% endif %}
            </td>
            <td>
                {% if user.is_banned %}
                <span class="status-badge banned">Banni</span>
                {% else %}
                <span class="status-badge active">Actif</span>
                {% endif %}
            </td>
            <td>{{ user.date_joined|date:"d M Y" }}</td>
            <td>
                {% if user != request.user and not user.is_superuser %}
                <div class="action-buttons">
                    <form method="POST" action="{% url 'administration:user_action' %}" class="inline-form">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <input type="hidden" name="action" value="toggle_ban">
                        <button type="submit"
                            class="btn-small {% if user.is_banned %}btn-success{% else %}btn-danger{% endif %}"
                            title="{% if user.is_banned %}DÃ©bannir{% else %}Bannir{% endif %}">
                            {% if user.is_banned %}ğŸ”“{% else %}ğŸš«{% endif %}
                            {% if user.is_banned %}DÃ©bannir{% else %}Bannir{% endif %}
                        </button>
                    </form>

                    {% if request.user.role_admin %}
                    <form method="POST" action="{% url 'administration:user_action' %}" class="inline-form">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <input type="hidden" name="action" value="toggle_moderator">
                        <button type="submit" class="btn-icon promote" title="Toggle ModÃ©rateur">
                            ğŸ›¡ï¸
                        </button>
                    </form>
                    {% endif %}
                </div>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="empty-state">Aucun utilisateur trouvÃ©.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
{% if is_paginated %}
<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
        <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&laquo; dÃ©but</a>
        <a
            href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">prÃ©cÃ©dent</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
        <a
            href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">suivant</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">fin
            &raquo;</a>
        {% endif %}
    </span>
</div>
{% endif %}
{% endblock %}