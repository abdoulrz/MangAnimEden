{% extends 'base.html' %}

{% block title %}Profil de {{ user.nickname }} - MangAnimEDen{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% load static %}{% static 'css/pages.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/domaine.css' %}?v={{ STATIC_VERSION }}">
<style>
    /* Inline override for profile specific layout if needed, though reuse is preferred */
    .profile-layout-container {
        display: flex;
        gap: 1.5rem;
        max-width: 1100px;
        /* Wider than original 800px to fit sidebar */
        margin: 0 auto;
        padding-top: var(--space-2xl);
        padding-bottom: var(--space-3xl);
    }

    .profile-main-content {
        flex: 1;
        min-width: 0;
    }

    .profile-sidebar {
        width: 280px;
        flex-shrink: 0;
        position: sticky;
        top: 50vh;
        transform: translateY(-50%);
        height: min-content;
        /* Important for sticky to work if parent is tall */
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-layout-container">

    <!-- Main Content Column -->
    <div class="profile-main-content">
        <!-- Header Notification -->
        <div class="profile-notification">
            <div class="notification-text">
                <h3>Compl√©tez votre profil</h3>
                <p>Personnalisez votre exp√©rience</p>
            </div>
            <a href="{% url 'users:edit_profile' %}" class="btn btn-primary btn-sm">Compl√©ter</a>
        </div>

        <!-- Main Profile Card (Premium Redesign) -->
        <div class="profile-card profile-card-premium">
            <div class="profile-header-gradient">
                <a href="{% url 'users:edit_profile' %}" class="edit-profile-btn" title="Modifier le profil">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </a>
            </div>

            <div class="profile-content-premium">
                <!-- Avatar with Ring -->
                <div class="profile-avatar-premium-wrapper">
                    <div class="profile-avatar-ring">
                        {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="{{ user.nickname }}" class="profile-avatar-img">
                        {% else %}
                        <div class="profile-avatar-placeholder">
                            {{ user.nickname|first|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="level-badge">Lvl {{ user.level }}</div>
                </div>

                <!-- User Info -->
                <div class="profile-identity">
                    <h1 class="profile-username">{{ user.nickname|default:user.username }}</h1>
                    <p class="profile-role">
                        {% if user.is_staff %}Administrateur{% else %}Membre Explorateur{% endif %}
                    </p>
                    <p class="member-since">Membre depuis {{ user.date_joined|date:"F Y" }}</p>
                </div>

                <!-- Level Progress -->
                <div class="level-progress-container">
                    <div class="level-info">
                        <span>XP</span>
                        <span>{{ level_data.current }} / {{ level_data.next }}</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" data-percent="{{ level_data.percent }}"
                            style="width: {{ level_data.percent }}%;"></div>
                    </div>
                </div>

                <!-- Stats Grid (Glass Cards) -->
                <div class="profile-stats-grid">
                    <div class="stat-glass-card">
                        <div class="stat-icon-wrapper icon-purple">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">42</span>
                            <span class="stat-label">Amis</span>
                        </div>
                    </div>

                    <div class="stat-glass-card">
                        <div class="stat-icon-wrapper icon-pink">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                                </path>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">12</span>
                            <span class="stat-label">Badges</span>
                        </div>
                    </div>

                    <div class="stat-glass-card">
                        <div class="stat-icon-wrapper icon-blue">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">{{ stats.total_chapters }}</span>
                            <span class="stat-label">Chapitres</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carte Otaku Banner -->
        <div class="otaku-card-banner">
            <div class="otaku-icon-wrapper">
                <span class="otaku-icon">üí≥</span>
            </div>
            <div class="otaku-text">
                <h3>Carte Otaku</h3>
                <p>Obtenez des r√©ductions exclusives</p>
            </div>
            <div class="otaku-arrow">‚Ä∫</div>
        </div>

        <!-- Dynamic Domaine Content (Replacing Quick Access) -->
        <div id="domaine-content-area"
            class="domaine-dynamic-content glass-panel custom-scrollbar profile-content-area">

            <!-- Default / Empty State (Optional) -->
            <div id="content-overview" class="content-block">
                <h2 class="section-title">Domaine</h2>
                <!-- Reusing a simpler quick access if needed, or just intro -->
                <div class="profile-welcome-panel profile-welcome-flex">

                    <div class="book-animation profile-book-animation">
                        <div class="book-cover"></div>
                        <div class="book-page"></div>
                        <div class="book-page"></div>
                    </div>

                    <h3>Bienvenue dans votre Espace</h3>
                    <p class="profile-welcome-text">S√©lectionnez une cat√©gorie √† droite pour voir vos contenus.
                    </p>
                </div>
            </div>

            <!-- Scans Block -->
            <div id="content-scans" class="content-block content-hidden">
                <h2 class="panel-title">üìö Mes Scans</h2>
                <div class="scans-grid">
                    {% for series in scans %}
                    <a href="{% url 'catalog:detail' series.id %}" class="scan-card">
                        {% if series.cover %}
                        <img src="{{ series.cover.url }}" alt="{{ series.title }}">
                        {% else %}
                        <div class="manga-cover placeholder">
                            <span>üìö</span>
                        </div>
                        {% endif %}
                        <h4>{{ series.title }}</h4>
                    </a>
                    {% empty %}
                    <div class="empty-state-container">
                        <div class="empty-state-animation">
                            <div class="book-animation">
                                <div class="book-cover"></div>
                                <div class="book-page"></div>
                                <div class="book-page"></div>
                            </div>
                        </div>
                        <p class="empty-state-text">Aucun scan enregistr√© pour le moment.</p>
                        <p class="empty-state-subtext">Commencez √† lire pour voir vos scans ici !</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Favoris Block -->
            <div id="content-favoris" class="content-block content-hidden">
                <h2 class="panel-title">‚ù§Ô∏è Mes Favoris</h2>
                <div class="scans-grid">
                    {% for series in favoris %}
                    <a href="{% url 'catalog:detail' series.id %}" class="scan-card">
                        {% if series.cover %}
                        <img src="{{ series.cover.url }}" alt="{{ series.title }}">
                        {% else %}
                        <div class="manga-cover placeholder">
                            <span>‚ù§Ô∏è</span>
                        </div>
                        {% endif %}
                        <h4>{{ series.title }}</h4>
                    </a>
                    {% empty %}
                    <div class="empty-state-container">
                        <div class="empty-state-animation">
                            <!-- Reuse animation or simple text -->
                            <p class="empty-state-text">Aucun favori pour le moment.</p>
                            <p class="empty-state-subtext">Ajoutez des s√©ries √† vos favoris pour les retrouver ici !</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Stats Block -->
            <div id="content-stats" class="content-block content-hidden">
                <h2 class="panel-title">üìä Statistiques de Lecture</h2>
                <div class="stats-dashboard">
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.total_chapters }}</div>
                        <div class="stat-label">Chapitres lus</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.series_in_progress }}</div>
                        <div class="stat-label">S√©ries en cours</div>
                    </div>
                    <div class="stat-card">
                        {% if stats.finished_series > 0 %}
                        <div class="stat-value">{{ stats.finished_series }}</div>
                        {% else %}
                        <div class="stat-value stat-value-large">üöß</div>
                        {% endif %}
                        <div class="stat-label">S√©ries termin√©es</div>
                    </div>
                </div>
            </div>

            <!-- History Block -->
            <div id="content-history" class="content-block content-hidden">
                <h2 class="panel-title">üìö Historique de Lecture</h2>
                <div class="history-timeline">
                    {% for series, progress_list in series_progress.items %}
                    <div class="history-group">
                        <h3 class="series-title">{{ series.title }}</h3>
                        {% for progress in progress_list %}
                        <div class="history-item">
                            <a href="{% url 'reader:demo_chapter' progress.chapter.id %}">
                                {% if series.cover %}
                                <img src="{{ series.cover.url }}" alt="{{ series.title }}" class="history-cover">
                                {% else %}
                                <div class="history-cover placeholder history-cover-placeholder">
                                    <span>üìö</span>
                                </div>
                                {% endif %}
                                <div class="history-details">
                                    <h4>Chapitre {{ progress.chapter.number }}</h4>
                                    <span class="history-time">{{ progress.last_read|timesince }}</span>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% empty %}
                    <p class="empty-message">Aucun historique de lecture.</p>
                    {% endfor %}
                </div>
            </div>

        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const sidebarLinks = document.querySelectorAll('.profile-sidebar .block-item');
                const contentBlocks = document.querySelectorAll('.content-block');
                const contentArea = document.getElementById('domaine-content-area');

                sidebarLinks.forEach(link => {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();

                        // EXTRACT TARGET ID
                        let targetId = 'overview';
                        const url = new URL(this.href, window.location.origin);
                        const mode = url.searchParams.get('mode');
                        if (mode) targetId = mode;

                        // 1. HIDE ALL BLOCKS FORCEFULLY
                        contentBlocks.forEach(block => {
                            block.style.display = 'none'; // Force inline hide
                            block.classList.add('content-hidden'); // Backup class
                        });

                        // 2. RESET ACTIVE STATE ON SIDEBAR
                        sidebarLinks.forEach(l => l.classList.remove('active'));

                        // 3. SHOW TARGET BLOCK
                        const targetBlock = document.getElementById('content-' + targetId);
                        if (targetBlock) {
                            targetBlock.style.display = 'block'; // Force inline show
                            targetBlock.classList.remove('content-hidden');
                            this.classList.add('active'); // Add active class to clicked link

                            // 4. SCROLL TO CONTENT CENTERED
                            if (contentArea) {
                                requestAnimationFrame(() => {
                                    contentArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                });
                            }
                        }
                    });
                });

                // FORCE PROGRESS BAR FIX - Read from data attribute
                const progressBar = document.querySelector('.progress-bar-fill');
                if (progressBar) {
                    const percentValue = parseFloat(progressBar.getAttribute('data-percent') || '0');
                    console.log('Progress bar percent:', percentValue); // Debug

                    if (percentValue === 0 || percentValue < 0.1) {
                        // Force complete invisibility for 0% or near-0%
                        progressBar.style.width = '0';
                        progressBar.style.minWidth = '0';
                        progressBar.style.opacity = '0';
                        progressBar.style.visibility = 'hidden';
                    } else {
                        // Ensure visible for non-zero values
                        progressBar.style.width = percentValue + '%';
                        progressBar.style.opacity = '1';
                        progressBar.style.visibility = 'visible';
                    }
                }
            });
        </script>

    </div>

    <!-- Right Sidebar (Fixed) -->
    <div class="profile-sidebar">
        <!-- Reusing sidebar-content class but ensuring it works with imported CSS -->
        <div class="glass-panel sidebar-content">
            <!-- Favoris -->
            <a href="{% url 'users:domaine' %}?mode=favoris" class="block-item" id="nav-item-favoris">
                <span class="block-icon">‚ù§Ô∏è</span>
                <span class="block-title">Favoris</span>
            </a>

            <!-- Scans -->
            <a href="{% url 'users:domaine' %}?mode=scans" class="block-item" id="nav-item-scans">
                <span class="block-icon">üìö</span>
                <span class="block-title">Scans</span>
            </a>

            <!-- Statistiques -->
            <a href="{% url 'users:domaine' %}?mode=stats" class="block-item" id="nav-item-stats">
                <span class="block-icon">üìä</span>
                <span class="block-title">Statistiques</span>
            </a>

            <!-- Historique -->
            <a href="{% url 'users:domaine' %}?mode=history" class="block-item" id="nav-item-history">
                <span class="block-icon">üìö</span>
                <span class="block-title">Historique</span>
            </a>
        </div>
    </div>

</div>
{% endblock %}