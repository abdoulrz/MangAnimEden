{% extends 'base.html' %}
{% load static %}

{% block title %}Profil de {{ user.nickname }} - MangAnimEDen{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block content %}
<div class="profile-layout-container">

    <!-- Main Content Column -->
    <div class="profile-main-content">
        <!-- Header Notification -->
        <div class="profile-notification">
            <div class="notification-text">
                <h3>Compl√©tez votre profil</h3>
                <p>Personnalisez votre exp√©rience</p>
            </div>
            <a href="{% url 'users:edit_profile' %}" class="btn btn-primary btn-sm">Compl√©ter</a>
        </div>

        <!-- Main Profile Card (Premium Redesign) -->
        <div class="profile-card profile-card-premium">
            <div class="profile-header-gradient">
                <a href="{% url 'users:edit_profile' %}" class="edit-profile-btn" title="Modifier le profil">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </a>
            </div>

            <div class="profile-content-premium">
                <!-- Avatar with Ring -->
                <div class="profile-avatar-premium-wrapper">
                    <div class="profile-avatar-ring">
                        {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="{{ user.nickname }}" class="profile-avatar-img">
                        {% else %}
                        <div class="profile-avatar-placeholder">
                            {{ user.nickname|first|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="level-badge">Lvl {{ user.level }}</div>
                </div>

                <!-- User Info -->
                <div class="profile-identity">
                    <h1 class="profile-username">{{ user.nickname|default:user.username }}</h1>
                    <p class="profile-role">
                        {% if user.is_staff %}Administrateur{% else %}Membre Explorateur{% endif %}
                    </p>
                    <p class="member-since">Membre depuis {{ user.date_joined|date:"F Y" }}</p>
                </div>

                <!-- Level Progress -->
                <div class="level-progress-container">
                    <div class="level-info">
                        <span>XP</span>
                        <span>{{ level_data.current }} / {{ level_data.next }}</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" data-percent="{{ level_data.percent }}"></div>
                    </div>
                </div>

                <!-- Stats Grid (Glass Cards) -->
                <div class="profile-stats-grid">
                    <!-- Friends Card - Clickable (Phase 2.5.2) -->
                    <div class="stat-glass-card stat-clickable" id="friends-card-toggle">
                        <div class="stat-icon-wrapper icon-purple">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">{{ friend_count }}</span>
                            <span class="stat-label">
                                Amis
                                {% if pending_count > 0 %}
                                <span class="pending-badge">{{ pending_count }}</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <a href="{% url 'users:domaine' %}?mode=badges" class="stat-glass-card stat-clickable">
                        <div class="stat-icon-wrapper icon-pink">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                                </path>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">{{ user_badges_count }} / {{ total_badges_count }}</span>
                            <span class="stat-label">Badges</span>
                        </div>
                    </a>

                    <div class="stat-glass-card">
                        <div class="stat-icon-wrapper icon-blue">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">{{ stats.total_chapters }}</span>
                            <span class="stat-label">Chapitres</span>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Friends Panel (Phase 2.5.2) -->
                <div id="friends-panel" class="friends-panel friends-panel-hidden">
                    <div class="friends-panel-header">
                        <h3>üë• Mes Amis</h3>
                        <button id="friends-panel-close" class="panel-close-btn" aria-label="Fermer">‚úï</button>
                    </div>

                    <!-- Pending Requests Section -->
                    {% if pending_requests %}
                    <div class="friends-section">
                        <h4 class="friends-section-title">üì¨ Demandes en attente ({{ pending_count }})</h4>
                        <div class="pending-requests-list">
                            {% for request in pending_requests %}
                            <div class="friend-request-item" data-request-id="{{ request.id }}">
                                <div class="friend-avatar-small">
                                    {% if request.requester.avatar %}
                                    <img src="{{ request.requester.avatar.url }}"
                                        alt="{{ request.requester.nickname }}">
                                    {% else %}
                                    <div class="avatar-placeholder-small">{{ request.requester.nickname|first|upper }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="friend-info">
                                    <span class="friend-nickname">{{ request.requester.nickname }}</span>
                                    <span class="friend-level">Niveau {{ request.requester.level }}</span>
                                </div>
                                <div class="friend-actions">
                                    <button class="btn-accept-friend" data-request-id="{{ request.id }}"
                                        title="Accepter">‚úì</button>
                                    <button class="btn-reject-friend" data-request-id="{{ request.id }}"
                                        title="Rejeter">‚úï</button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Friends List Section -->
                    <div class="friends-section">
                        <h4 class="friends-section-title">‚ú® Liste d'amis</h4>
                        <div id="friends-list-container" class="friends-list">
                            <div class="loading-spinner">Chargement...</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Carte Otaku Banner -->
        <div class="otaku-card-banner">
            <div class="otaku-icon-wrapper">
                <span class="otaku-icon">üí≥</span>
            </div>
            <div class="otaku-text">
                <h3>Carte Otaku</h3>
                <p>Obtenez des r√©ductions exclusives</p>
            </div>
            <div class="otaku-arrow">‚Ä∫</div>
        </div>

        <!-- Dynamic Domaine Content (Replacing Quick Access) -->
        <div id="domaine-content-area"
            class="domaine-dynamic-content glass-panel custom-scrollbar profile-content-area">

            <!-- Default / Empty State (Optional) -->
            <div id="content-overview" class="content-block">
                <h2 class="section-title">Domaine</h2>
                <!-- Reusing a simpler quick access if needed, or just intro -->
                <div class="profile-welcome-panel profile-welcome-flex">

                    <div class="book-animation profile-book-animation">
                        <div class="book-cover"></div>
                        <div class="book-page"></div>
                        <div class="book-page"></div>
                    </div>

                    <h3>Bienvenue dans votre Espace</h3>
                    <p class="profile-welcome-text">S√©lectionnez une cat√©gorie √† droite pour voir vos contenus.
                    </p>
                </div>
            </div>

            <!-- Scans Block -->
            <div id="content-scans" class="content-block content-hidden">
                <h2 class="panel-title">üìö Mes Scans</h2>
                <div class="scans-grid">
                    {% for series in scans %}
                    <a href="{% url 'catalog:detail' series.id %}" class="scan-card">
                        {% if series.cover %}
                        <img src="{{ series.cover.url }}" alt="{{ series.title }}">
                        {% else %}
                        <div class="manga-cover placeholder">
                            <span>üìö</span>
                        </div>
                        {% endif %}
                        <h4>{{ series.title }}</h4>
                    </a>
                    {% empty %}
                    <div class="empty-state-container">
                        <div class="empty-state-animation">
                            <div class="book-animation">
                                <div class="book-cover"></div>
                                <div class="book-page"></div>
                                <div class="book-page"></div>
                            </div>
                        </div>
                        <p class="empty-state-text">Aucun scan enregistr√© pour le moment.</p>
                        <p class="empty-state-subtext">Commencez √† lire pour voir vos scans ici !</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Favoris Block -->
            <div id="content-favoris" class="content-block content-hidden">
                <h2 class="panel-title">‚ù§Ô∏è Mes Favoris</h2>
                <div class="scans-grid">
                    {% for series in favoris %}
                    <a href="{% url 'catalog:detail' series.id %}" class="scan-card">
                        {% if series.cover %}
                        <img src="{{ series.cover.url }}" alt="{{ series.title }}">
                        {% else %}
                        <div class="manga-cover placeholder">
                            <span>‚ù§Ô∏è</span>
                        </div>
                        {% endif %}
                        <h4>{{ series.title }}</h4>
                    </a>
                    {% empty %}
                    <div class="empty-state-container">
                        <div class="empty-state-animation">
                            <!-- Reuse animation or simple text -->
                            <p class="empty-state-text">Aucun favori pour le moment.</p>
                            <p class="empty-state-subtext">Ajoutez des s√©ries √† vos favoris pour les retrouver ici !</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Stats Block -->
            <div id="content-stats" class="content-block content-hidden">
                <h2 class="panel-title">üìä Statistiques de Lecture</h2>
                <div class="stats-dashboard">
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.total_chapters }}</div>
                        <div class="stat-label">Chapitres lus</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.series_in_progress }}</div>
                        <div class="stat-label">S√©ries en cours</div>
                    </div>
                    <div class="stat-card">
                        {% if stats.finished_series > 0 %}
                        <div class="stat-value">{{ stats.finished_series }}</div>
                        {% else %}
                        <div class="stat-value stat-value-large">üöß</div>
                        {% endif %}
                        <div class="stat-label">S√©ries termin√©es</div>
                    </div>
                </div>
            </div>

            <!-- History Block -->
            <div id="content-history" class="content-block content-hidden">
                <h2 class="panel-title">üìö Historique de Lecture</h2>
                <div class="history-timeline">
                    {% for series, progress_list in series_progress.items %}
                    <div class="history-group">
                        <h3 class="series-title">{{ series.title }}</h3>
                        {% for progress in progress_list %}
                        <div class="history-item">
                            <a href="{% url 'reader:demo_chapter' progress.chapter.id %}">
                                {% if series.cover %}
                                <img src="{{ series.cover.url }}" alt="{{ series.title }}" class="history-cover">
                                {% else %}
                                <div class="history-cover placeholder history-cover-placeholder">
                                    <span>üìö</span>
                                </div>
                                {% endif %}
                                <div class="history-details">
                                    <h4>Chapitre {{ progress.chapter.number }}</h4>
                                    <span class="history-time">{{ progress.last_read|timesince }}</span>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% empty %}
                    <p class="empty-message">Aucun historique de lecture.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Badges Block (Phase 2.5.3) -->
            <div id="content-badges" class="content-block content-hidden">
                <h2 class="panel-title">üèÜ Mes Badges</h2>
                <div class="badge-timeline-container">
                    <div class="timeline-line"></div>

                    {% for item in timeline_badges %}
                    <div class="timeline-item {{ item.status }}">
                        <div class="timeline-dot">
                            {% if item.status == 'unlocked' and item.badge.icon %}
                            <img src="{{ item.badge.icon.url }}" alt="{{ item.badge.name }}" class="badge-icon-small">
                            {% elif item.status == 'next' %}
                            <div class="dot-next"></div>
                            {% else %}
                            <div class="dot-locked"></div>
                            {% endif %}
                        </div>

                        <div class="timeline-content">
                            <div class="badge-header">
                                <h4>{{ item.badge.name }}</h4>
                                {% if item.obtained_at %}
                                <span class="badge-date">{{ item.obtained_at|date:"d M Y" }}</span>
                                {% endif %}
                            </div>
                            <p class="badge-condition">{{ item.badge.description }}</p>
                            {% if item.status == 'next' %}
                            <span class="badge-status-label">Prochain Objectif</span>
                            {% elif item.status == 'locked' %}
                            <span class="badge-status-label locked">Verrouill√©</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="empty-message">Aucun badge disponible.</p>
                    {% endfor %}

                </div>
            </div>

        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const sidebarLinks = document.querySelectorAll('.profile-sidebar .block-item');
                const contentBlocks = document.querySelectorAll('.content-block');
                const contentArea = document.getElementById('domaine-content-area');
                const badgesCard = document.querySelector('a[href*="mode=badges"]'); // Select the Glass Card

                // Function to switch content mode
                function switchToMode(mode) {
                    if (!mode) return;

                    // 1. HIDE ALL BLOCKS
                    contentBlocks.forEach(block => {
                        block.style.display = 'none';
                        block.classList.add('content-hidden');
                    });

                    // 2. RESET ACTIVE STATE ON SIDEBAR
                    sidebarLinks.forEach(l => l.classList.remove('active'));

                    // 3. SHOW TARGET BLOCK
                    const targetBlock = document.getElementById('content-' + mode);
                    if (targetBlock) {
                        targetBlock.style.display = 'block';
                        targetBlock.classList.remove('content-hidden');

                        // Update active state in sidebar if matching link exists
                        sidebarLinks.forEach(link => {
                            if (link.href.includes('mode=' + mode)) {
                                link.classList.add('active');
                            }
                        });

                        // 4. SCROLL TO CONTENT CENTERED
                        if (contentArea) {
                            requestAnimationFrame(() => {
                                contentArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            });
                        }
                    }
                }

                // Generic Click Handler
                function handleNavigationClick(e) {
                    e.preventDefault();
                    const url = new URL(this.href, window.location.origin);
                    const mode = url.searchParams.get('mode');
                    if (mode) {
                        // Update URL without reload (History API)
                        window.history.pushState({ mode: mode }, '', url);
                        switchToMode(mode);
                    }
                }

                // Attach to Sidebar Links
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', handleNavigationClick);
                });

                // Attach to Badges Card if it exists
                if (badgesCard) {
                    badgesCard.addEventListener('click', handleNavigationClick);
                }

                // Handle Page Load / Back Button
                const urlParams = new URLSearchParams(window.location.search);
                const initialMode = urlParams.get('mode');
                if (initialMode) {
                    switchToMode(initialMode);
                }

                // Handle Browser Back/Forward buttons
                window.addEventListener('popstate', function (event) {
                    const mode = event.state ? event.state.mode : (new URLSearchParams(window.location.search).get('mode') || 'overview');
                    switchToMode(mode);
                });

                // FORCE PROGRESS BAR FIX - Read from data attribute
                const progressBar = document.querySelector('.progress-bar-fill');
                if (progressBar) {
                    const percentValue = parseFloat(progressBar.getAttribute('data-percent') || '0');
                    console.log('Progress bar percent:', percentValue); // Debug

                    if (percentValue === 0 || percentValue < 0.1) {
                        // Force complete invisibility for 0% or near-0%
                        progressBar.style.width = '0';
                        progressBar.style.minWidth = '0';
                        progressBar.style.opacity = '0';
                        progressBar.style.visibility = 'hidden';
                    } else {
                        // Ensure visible for non-zero values
                        progressBar.style.width = percentValue + '%';
                        progressBar.style.opacity = '1';
                        progressBar.style.visibility = 'visible';
                    }
                }
            });

            // ========== FRIENDS PANEL FUNCTIONALITY (Phase 2.5.2) ==========

            const friendsCardToggle = document.getElementById('friends-card-toggle');
            const friendsPanel = document.getElementById('friends-panel');
            const friendsPanelClose = document.getElementById('friends-panel-close');
            const friendsListContainer = document.getElementById('friends-list-container');

            // Toggle friends panel
            if (friendsCardToggle && friendsPanel) {
                friendsCardToggle.addEventListener('click', function () {
                    const isHidden = friendsPanel.classList.contains('friends-panel-hidden');

                    if (isHidden) {
                        friendsPanel.classList.remove('friends-panel-hidden');
                        loadFriendsList();
                    } else {
                        friendsPanel.classList.add('friends-panel-hidden');
                    }
                });
            }



            // Close panel button
            if (friendsPanelClose) {
                friendsPanelClose.addEventListener('click', function () {
                    friendsPanel.classList.add('friends-panel-hidden');
                });
            }


            // Load friends list via AJAX
            function loadFriendsList() {
                if (!friendsListContainer) return;

                friendsListContainer.innerHTML = '<div class="loading-spinner">Chargement...</div>';

                fetch('/forum/friends/list/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.friends.length > 0) {
                            let html = '';
                            data.friends.forEach(friend => {
                                const avatarHtml = friend.avatar
                                    ? `<img src="${friend.avatar}" alt="${friend.nickname}">`
                                    : `<div class="avatar-placeholder-small">${friend.nickname.charAt(0).toUpperCase()}</div>`;

                                html += `
                                    <div class="friend-item" data-user-id="${friend.id}">
                                        <div class="friend-avatar-small">${avatarHtml}</div>
                                        <div class="friend-info">
                                            <span class="friend-nickname">${friend.nickname}</span>
                                            <span class="friend-level">Niveau ${friend.level}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            friendsListContainer.innerHTML = html;
                        } else {
                            friendsListContainer.innerHTML = '<p class="empty-message">Aucun ami pour le moment.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading friends:', error);
                        friendsListContainer.innerHTML = '<p class="error-message">Erreur de chargement</p>';
                    });
            }

            // Accept friend request
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('btn-accept-friend')) {
                    const requestId = e.target.dataset.requestId;
                    const requestItem = e.target.closest('.friend-request-item');

                    fetch(`/forum/friends/accept/${requestId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove request item with animation
                                requestItem.style.opacity = '0';
                                setTimeout(() => {
                                    requestItem.remove();
                                    // Reload friends list
                                    loadFriendsList();
                                    // Update counter (reload page or update manually)
                                    location.reload();
                                }, 300);
                            }
                        })
                        .catch(error => console.error('Error accepting friend:', error));
                }
            });

            // Reject friend request
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('btn-reject-friend')) {
                    const requestId = e.target.dataset.requestId;
                    const requestItem = e.target.closest('.friend-request-item');

                    fetch(`/forum/friends/reject/${requestId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                requestItem.style.opacity = '0';
                                setTimeout(() => {
                                    requestItem.remove();
                                    location.reload();
                                }, 300);
                            }
                        })
                        .catch(error => console.error('Error rejecting friend:', error));
                }
            });

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // FORCE PROGRESS BAR FIX
            const progressBar = document.querySelector('.progress-bar-fill');
            if (progressBar) {
                const percentValue = parseFloat(progressBar.getAttribute('data-percent') || '0');
                if (percentValue === 0 || percentValue < 0.1) {
                    progressBar.style.width = '0';
                    progressBar.style.opacity = '0';
                    progressBar.style.visibility = 'hidden';
                } else {
                    progressBar.style.width = percentValue + '%';
                    progressBar.style.opacity = '1';
                    progressBar.style.visibility = 'visible';
                }
            }
        </script>

    </div>

    <!-- Right Sidebar (Fixed) -->
    <div class="profile-sidebar">
        <!-- Reusing sidebar-content class but ensuring it works with imported CSS -->
        <div class="glass-panel sidebar-content">
            <!-- Favoris -->
            <a href="{% url 'users:domaine' %}?mode=favoris" class="block-item" id="nav-item-favoris">
                <span class="block-icon">‚ù§Ô∏è</span>
                <span class="block-title">Favoris</span>
            </a>

            <!-- Scans -->
            <a href="{% url 'users:domaine' %}?mode=scans" class="block-item" id="nav-item-scans">
                <span class="block-icon">üìö</span>
                <span class="block-title">Scans</span>
            </a>

            <!-- Statistiques -->
            <a href="{% url 'users:domaine' %}?mode=stats" class="block-item" id="nav-item-stats">
                <span class="block-icon">üìä</span>
                <span class="block-title">Statistiques</span>
            </a>

            <!-- Historique -->
            <a href="{% url 'users:domaine' %}?mode=history" class="block-item" id="nav-item-history">
                <span class="block-icon">üìö</span>
                <span class="block-title">Historique</span>
            </a>
        </div>
    </div>

</div>
{% endblock %}