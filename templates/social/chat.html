{% extends 'base.html' %}
{% load static %}

{% block title %}Social - MangaAnimEden{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}
<div class="chat-page-container">
    <!-- 1. Top Section: Stories (reusing classes from pages.css) -->
    <div class="stories-section">
        <div class="stories-container">
            {% for story in stories %}
            {% if story.is_add %}
            <button class="story-item story-add">
                <div class="story-ring">
                    <div class="story-circle">
                        <span class="story-add-icon">+</span>
                    </div>
                </div>
                <span class="story-name">{{ story.name }}</span>
            </button>
            {% else %}
            <div class="story-item">
                <div class="story-ring has-story">
                    <div class="story-circle">
                        <span>{{ story.name|slice:":2"|upper }}</span>
                    </div>
                </div>
                <span class="story-name">{{ story.name }}</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- 2. Main 3-Column Layout -->
    <div class="chat-main-layout">

        <!-- Left Column: Groups -->
        <div class="sidebar-container groups-sidebar">
            <h2 class="section-title">Groupes</h2>
            <div class="glass-panel sidebar-content">
                <div class="groups-list">
                    {% for group in groups %}
                    <a href="?group_id={{ group.id }}"
                        class="group-card {% if active_group.id == group.id %}active{% endif %}">
                        <div class="group-icon">
                            {% if group.icon %}
                            <img src="{{ group.icon.url }}" alt="{{ group.name }}">
                            {% else %}
                            <span>{{ group.name|slice:":1"|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="group-info">
                            <span class="group-name">{{ group.name }}</span>
                            <span class="group-desc-short">{{ group.description|truncatechars:30 }}</span>
                        </div>
                    </a>
                    {% empty %}
                    <p class="no-data">Aucun groupe.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Center Column: Chat Window -->
        <div class="chat-window-container">
            {% if active_group %}
            <div class="glass-panel chat-window">
                <div class="chat-header">
                    <h3>{{ active_group.name }}</h3>
                    <p class="group-desc">{{ active_group.description|truncatechars:50 }}</p>
                </div>

                <div class="chat-messages" id="chatMessages">
                    {% for message in messages %}
                    <div class="message {% if message.sender == user %}my-message{% else %}other-message{% endif %}">
                        <div class="message-bubble">
                            <div class="message-info">
                                <span class="sender-name">{{ message.sender.nickname }}</span>
                                <span class="timestamp">{{ message.timestamp|date:"H:i" }}</span>
                            </div>
                            <p class="message-text">{{ message.content }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <h3>Pas encore de messages...</h3>
                        <p>Commencez la conversation !</p>
                    </div>
                    {% endfor %}
                </div>

                <div class="chat-input-area">
                    <form method="post" action="?group_id={{ active_group.id }}" class="chat-form">
                        {% csrf_token %}
                        <input type="text" name="content" class="chat-input" placeholder="√âcrivez votre message..."
                            autocomplete="off" required>
                        <button type="submit" class="send-btn">
                            üöÄ
                        </button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="glass-panel empty-selection">
                <div class="empty-content">
                    <h2>S√©lectionnez un groupe pour discuter</h2>
                    <p>Rejoignez une conversation via le menu de gauche.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Events -->
        <div class="sidebar-container events-sidebar">
            <h2 class="section-title">Events</h2>
            <div class="glass-panel sidebar-content">
                <div class="events-list">
                    {% for event in events %}
                    <div class="event-card">
                        <div class="event-image">
                            {% if event.image %}
                            <img src="{{ event.image.url }}" alt="{{ event.title }}">
                            {% else %}
                            <div class="event-placeholder">üìÖ</div>
                            {% endif %}
                        </div>
                        <div class="event-details">
                            <h4>{{ event.title }}</h4>
                            <p class="event-date">{{ event.date|date:"d M" }}</p>
                            <p class="event-location">üìç {{ event.location }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="no-data">Aucun √©v√©nement.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Auto scroll to bottom of chat
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}