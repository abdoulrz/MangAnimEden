{% extends 'base.html' %}
{% load static %}

{% block title %}Social - MangaAnimEden{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}?v={{ STATIC_VERSION }}">
<style>
    .forum-sender-link {
        color: inherit;
        text-decoration: none;
        transition: opacity 0.3s;
    }

    .reply-banner-hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-page-container">
    <!-- 1. Top Section: Stories -->
    <div class="stories-section">
        <div class="stories-container">
            {% if can_post_story %}
            <div class="story-item story-add" onclick="openStoryModal()">
                <div class="story-ring">
                    <div class="story-circle">
                        <span class="story-add-icon">+</span>
                    </div>
                </div>
                <span class="story-name">Ajouter</span>
            </div>
            {% endif %}

            {% for group in story_groups %}
            <a href="?story_group_id={{ group.id }}" class="story-item">
                <div class="story-ring has-story {% if active_story_group == group %}active{% endif %}">
                    <div class="story-circle">
                        {% if group.icon %}
                        <img src="{{ group.icon.url }}" alt="{{ group.name }}" class="story-user-avatar">
                        {% else %}
                        <span>{{ group.name|slice:":1"|upper }}</span>
                        {% endif %}
                    </div>
                </div>
                <span class="story-name">{{ group.name }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Story Upload Modal -->
    <div id="storyModal" class="modal-overlay hidden">
        <div class="glass-panel modal-content">
            <div class="modal-header">
                <h3>Nouvelle Story de Groupe</h3>
                <span class="close-modal" onclick="closeStoryModal()">√ó</span>
            </div>
            <form method="post" enctype="multipart/form-data" class="story-form-styled">
                {% csrf_token %}
                <div class="form-group">
                    <label for="group-select">Choisir le groupe</label>
                    <select name="target_group_id" id="group-select" class="modal-select" required>
                        <option value="">-- S√©lectionner --</option>
                        {% for g in groups %}
                        <option value="{{ g.id }}">{{ g.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group file-upload-group">
                    <label for="story_file" class="file-dummy">
                        <span>üì§ S√©lectionner une image</span>
                    </label>
                    <input type="file" name="story_image" id="story_file" accept="image/*" required
                        onchange="updateFileName(this)">
                    <span id="file-name" class="file-name-display">Aucun fichier choisi</span>
                </div>
                <button type="submit" class="modal-submit-btn">Publier</button>
            </form>
        </div>
    </div>

    <!-- 2. Main 3-Column Layout -->
    <div class="chat-main-layout">

        <!-- Left Column: Groups -->
        <div class="sidebar-container groups-sidebar">
            <h2 class="section-title">
                Groupes
                {% if user.level >= 50 or user.role_moderator or user.is_staff %}
                <a href="{% url 'social:create_group' %}" class="btn-group-add" title="Cr√©er un groupe">
                    <span>+</span>
                </a>
                {% endif %}
            </h2>

            <!-- Tabs Navigation -->
            <div class="sidebar-tabs">
                <a href="?tab=my_groups" class="sidebar-tab {% if active_tab == 'my_groups' %}active{% endif %}">Mes
                    Groupes</a>
                <a href="?tab=discover"
                    class="sidebar-tab {% if active_tab == 'discover' %}active{% endif %}">D√©couvrir</a>
            </div>

            <div class="glass-panel sidebar-content">
                <div class="groups-list">
                    {% if active_tab == 'my_groups' %}
                    {% for group in my_groups %}
                    <a href="?group_id={{ group.id }}&tab=my_groups"
                        class="group-card {% if active_group.id == group.id %}active{% endif %}">
                        <div class="group-icon">
                            {% if group.icon %}
                            <img src="{{ group.icon.url }}" alt="{{ group.name }}">
                            {% else %}
                            <span>{{ group.name|slice:":1"|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="group-info">
                            <span class="group-name">{{ group.name }}</span>
                            <span class="group-desc-short">{{ group.description|truncatechars:30 }}</span>
                        </div>
                    </a>
                    {% empty %}
                    <div class="empty-state-small">
                        <p class="no-data">Vous n'avez rejoint aucun groupe.</p>
                        <a href="?tab=discover" class="btn-small-cta">D√©couvrir</a>
                    </div>
                    {% endfor %}
                    {% else %}
                    {% for group in other_groups %}
                    <a href="?group_id={{ group.id }}&tab=discover"
                        class="group-card {% if active_group.id == group.id %}active{% endif %}">
                        <div class="group-icon">
                            {% if group.icon %}
                            <img src="{{ group.icon.url }}" alt="{{ group.name }}">
                            {% else %}
                            <span>{{ group.name|slice:":1"|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="group-info">
                            <span class="group-name">{{ group.name }}</span>
                            <span class="group-member-count">üëÅÔ∏è Public</span>
                        </div>
                    </a>
                    {% empty %}
                    <p class="no-data">Aucun nouveau groupe √† d√©couvrir.</p>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Center Column: Dynamic Content -->
        <div class="chat-window-container">

            {% if active_mode == 'chat' %}
            <!-- Chat View -->
            <div class="glass-panel chat-window">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <h3>{{ active_group.name }}</h3>
                        <p class="group-desc">{{ active_group.description|truncatechars:50 }}</p>
                    </div>
                    <div class="chat-header-actions">
                        {% if is_member %}
                        {% if active_group.owner != user %}
                        <a href="{% url 'social:leave_group' active_group.id %}" class="btn-leave-group"
                            onclick="return confirm('Voulez-vous vraiment quitter ce groupe ?')">Quitter</a>
                        {% endif %}
                        {% else %}
                        <a href="{% url 'social:join_group' active_group.id %}" class="btn-join-group">Rejoindre</a>
                        {% endif %}

                        {% if active_group.owner == user %}
                        <span class="badge bg-primary">Propri√©taire</span>
                        {% endif %}
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">

                    {% if not is_member and not user.is_staff and active_group.owner != user %}
                    <!-- Blurred Preview / Join Prompt -->
                    <div class="join-prompt-overlay">
                        <div class="join-prompt-content">
                            <div class="lock-icon">üîí</div>
                            <h3>Groupe Priv√©</h3>
                            <p>Rejoignez le groupe <strong>{{ active_group.name }}</strong> pour voir les messages et
                                discuter avec les membres.</p>
                            <a href="{% url 'social:join_group' active_group.id %}" class="btn-join-large">Rejoindre le
                                Groupe</a>
                        </div>
                    </div>
                    {% elif is_banned %}
                    <!-- Banned UI -->
                    <div class="banned-overlay">
                        <div class="banned-content">
                            <div class="ban-icon">üö´</div>
                            <h3>Acc√®s Restreint</h3>
                            <p>Vous avez √©t√© banni de ce groupe par le mod√©rateur.</p>
                            <p class="ban-note">Contactez le propri√©taire si vous pensez qu'il s'agit d'une erreur.</p>
                        </div>
                    </div>
                    {% else %}
                    <!-- Normal Chat Messages -->
                    {% for message in messages %}
                    <div class="message {% if message.sender == user %}my-message{% else %}other-message{% endif %}"
                        id="msg-{{ message.id }}">
                        <div class="message-bubble">
                            <div class="message-info">
                                <a href="{% url 'users:public_profile' message.sender.id %}"
                                    class="sender-name forum-sender-link">{{ message.sender.nickname }}</a>
                                <span class="timestamp">{{ message.timestamp|date:"H:i" }}</span>

                                {% if active_group.owner == user and message.sender != user %}
                                <button class="btn-ban"onclick="banUser({{ active_group.id }}, {{ message.sender.id }}, '{{ message.sender.nickname }}')"title="Bannir ce membre">üö´</button>
                                {% endif %}
                            </div>

                            {% if message.parent %}
                            <div class="reply-context">
                                <small>R√©ponse √† <strong>{{ message.parent.sender.nickname }}</strong> : {{
                                    message.parent.content|truncatechars:30 }}</small>
                            </div>
                            {% endif %}

                            <p class="message-text">{{ message.content }}</p>

                            <!-- Interactions -->
                            <div class="message-actions">
                                <button class="action-btn like-btn {% if user in message.likes.all %}liked{% endif %}"
                                    data-message-id="{{ message.id }}" onclick="toggleLike(this,{{ message.id }})">
                                    <i
                                        class="{% if user in message.likes.all %}fas{% else %}far{% endif %} fa-heart"></i>
                                    <span class="like-count">{{ message.like_count }}</span>
                                </button>
                                <button type="button" class="action-btn reply-btn" title="R√©pondre"
                                    aria-label="R√©pondre"
                                    onclick="startReply({{ message.id }}, '{{ message.sender.nickname }}')">
                                    <i class="fas fa-reply"></i>
                                </button>
                            </div>

                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <h3>Pas encore de messages...</h3>
                        <p>Commencez la conversation !</p>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                {% if is_member and not is_banned or active_group.owner == user %}
                <div class="chat-input-area">
                    <!-- Reply Banner (Hidden by default) -->
                    <div id="replyBanner" class="reply-banner reply-banner-hidden">
                        <span>R√©ponse √† <strong id="replyTargetName">User</strong></span>
                        <button class="btn-close-small" onclick="cancelReply()">√ó</button>
                    </div>

                    <form method="post" action="?group_id={{ active_group.id }}" class="chat-form">
                        {% csrf_token %}
                        <input type="hidden" name="parent_id" id="parentInput">
                        <input type="text" name="content" id="chatInput" class="chat-input"
                            placeholder="√âcrivez votre message..." autocomplete="off" required>
                        <button type="submit" class="send-btn">üöÄ</button>
                    </form>
                </div>
                {% endif %}
            </div>

            {% elif active_mode == 'story' %}
            <!-- Story View (Full) -->
            <div class="glass-panel story-view-container">
                <div class="story-view-header">
                    <h3>Stories : {{ active_story_group.name }}</h3>
                    <a href="{% url 'social:forum_home' %}" class="close-story-btn">√ó</a>
                </div>
                <div class="story-carousel">
                    {% for story in active_group_stories %}
                    <div class="story-card-full">
                        <img src="{{ story.image.url }}" alt="Story">
                        <a href="?group_id={{ active_story_group.id }}" class="discuss-btn">
                            üí¨ Discuter ici
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% elif active_mode == 'event' %}
            <!-- Event View (Centered) -->
            <div class="glass-panel event-view-container text-center">
                <div class="event-view-header">
                    <h3>{{ active_event.title }}</h3>
                    <a href="{% url 'social:forum_home' %}" class="close-event-btn">√ó</a>
                </div>
                <div class="event-focused-content">
                    <div class="event-icon-medium">
                        {% if active_event.image %}
                        <img src="{{ active_event.image.url }}" alt="{{ active_event.title }}">
                        {% else %}
                        <span>üìÖ</span>
                        {% endif %}
                    </div>

                    <div class="event-meta-centered">
                        <p class="event-date-large">
                            {{ active_event.date|date:"d/m/y" }}
                            <span class="date-separator">‚óè</span>
                            {{ active_event.date|date:"H:i" }}
                        </p>
                        <p class="event-location-large">üìç {{ active_event.location }}</p>
                    </div>

                    <div class="event-description-centered">
                        {{ active_event.description|linebreaks }}
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Default View -->
            <div class="glass-panel empty-selection">
                <div class="empty-content">
                    <div class="logo-animation">
                        <span class="logo-icon">üå∏</span>
                    </div>
                    <h2>MangaAnimEden Forum</h2>
                    <p>S√©lectionnez un groupe, une story, ou un event pour afficher les d√©tails.</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Events -->
        <div class="sidebar-container events-sidebar">
            <h2 class="section-title">Events</h2>
            <div class="glass-panel sidebar-content">
                <div class="events-list">
                    {% for event in events %}
                    <a href="?event_id={{ event.id }}"
                        class="event-card {% if active_event.id == event.id %}active{% endif %}">
                        <div class="event-image">
                            {% if event.image %}
                            <img src="{{ event.image.url }}" alt="{{ event.title }}">
                            {% else %}
                            <div class="event-placeholder">üìÖ</div>
                            {% endif %}
                        </div>
                        <div class="event-details">
                            <h4>{{ event.title }}</h4>
                            <p class="event-date">{{ event.date|date:"d M" }}</p>
                            <p class="event-location">üìç {{ event.location }}</p>
                        </div>
                    </a>
                    {% empty %}
                    <p class="no-data">Aucun √©v√©nement.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Auto scroll to bottom of chat
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Modal Logic
    function openStoryModal() {
        const modal = document.getElementById('storyModal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
    }

    function closeStoryModal() {
        const modal = document.getElementById('storyModal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }

    function updateFileName(input) {
        const display = document.getElementById('file-name');
        if (input.files && input.files.length > 0) {
            display.textContent = input.files[0].name;
        } else {
            display.textContent = "Aucun fichier choisi";
        }
    }

    // Close modal on outside click
    window.onclick = function (event) {
        const modal = document.getElementById('storyModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    function banUser(groupId, userId, nickname) {
        if (!confirm(`Voulez-vous vraiment bannir/d√©bannir ${nickname} de ce groupe ?`)) return;

        fetch(`/social/groups/${groupId}/ban/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Erreur: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Interactions
    function toggleLike(btn, messageId) {
        fetch(`/forum/messages/${messageId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const icon = btn.querySelector('i');
                    const count = btn.querySelector('.like-count');

                    count.textContent = data.count;
                    if (data.liked) {
                        btn.classList.add('liked');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        btn.classList.remove('liked');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }
                }
            });
    }

    function startReply(messageId, nickname) {
        document.getElementById('parentInput').value = messageId;
        document.getElementById('replyTargetName').textContent = nickname;
        document.getElementById('replyBanner').style.display = 'flex';
        document.getElementById('chatInput').focus();
    }

    function cancelReply() {
        document.getElementById('parentInput').value = '';
        document.getElementById('replyBanner').style.display = 'none';
    }

    // Long Press Logic for Mobile/Tablet
    let pressTimer;
    const longPressDuration = 800; // 0.8s for better responsiveness
    const chatContainer = document.getElementById('chatMessages');

    if (chatContainer) {
        chatContainer.addEventListener('touchstart', handlePressStart, { passive: true });
        chatContainer.addEventListener('touchend', handlePressEnd);
        chatContainer.addEventListener('touchmove', handlePressEnd); // Cancel on scroll

        chatContainer.addEventListener('mousedown', handlePressStart);
        chatContainer.addEventListener('mouseup', handlePressEnd);
        chatContainer.addEventListener('mouseleave', handlePressEnd);
    }

    function handlePressStart(e) {
        // Find the message bubble
        const bubble = e.target.closest('.message-bubble');
        if (!bubble) return;

        // Get message data from the reply button within the bubble
        // OR we can parse it from the DOM if we add data attributes. 
        // Reliance on finding the button is fragile but works with current structure.
        const replyBtn = bubble.querySelector('.reply-btn');
        if (!replyBtn) return;

        // Extract data from onclick attribute is messy. 
        // Better: let's use the ID from the parent .message
        const messageDiv = bubble.closest('.message');
        if (!messageDiv) return;

        const messageId = messageDiv.id.replace('msg-', '');
        const senderName = messageDiv.querySelector('.sender-name').textContent.trim();

        bubble.classList.add('pressing');

        pressTimer = setTimeout(() => {
            startReply(messageId, senderName);
            bubble.classList.remove('pressing');
            if (navigator.vibrate) navigator.vibrate(50);
        }, longPressDuration);
    }

    function handlePressEnd(e) {
        clearTimeout(pressTimer);
        const bubbles = document.querySelectorAll('.message-bubble.pressing');
        bubbles.forEach(b => b.classList.remove('pressing'));
    }
</script>
{% endblock %}